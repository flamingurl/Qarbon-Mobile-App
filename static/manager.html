<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarbon Aerospace | Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header><div class="container"><h1>Qarbon Aerospace Management</h1></div></header>

    <div class="container">
        <div class="manager-section">
            <h2>System Commands</h2>
            <button id="bulkAssignBtn" class="btn-primary" style="width:100%; padding:15px; font-weight:bold;">EXECUTE GLOBAL AI TASK DISTRIBUTION</button>
        </div>

        <div class="form-row">
            <div class="manager-section">
                <h2>Personnel Registration</h2>
                <form id="workerForm">
                    <input type="text" id="workerName" placeholder="Full Name" required>
                    <input type="text" id="workerRole" placeholder="Job Title" required>
                    <div id="regCalendar" class="calendar-grid"></div>
                    <button type="submit" class="btn-success" style="width:100%">Register Personnel</button>
                </form>
            </div>
            <div class="manager-section">
                <h2>Task Intake</h2>
                <form id="taskForm">
                    <input type="text" id="taskDesc" placeholder="Description" required>
                    <input type="number" id="taskUrg" placeholder="Urgency (1-5)" min="1" max="5" required>
                    <button type="submit" class="btn-primary" style="width:100%">Log Task</button>
                </form>
            </div>
        </div>

        <div class="manager-section"><h2>Live Operational Tasks</h2><div id="activeTasks" class="tasks-grid"></div></div>
        <div class="manager-section"><h2>Active Personnel Directory</h2><div id="workersOverview"></div></div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let currentShifts = {};

        async function loadData() {
            const [tRes, wRes] = await Promise.all([fetch(`${API_URL}/tasks`), fetch(`${API_URL}/workers`)]);
            const tasks = await tRes.json();
            const workers = await wRes.json();

            // Task Cards
            document.getElementById('activeTasks').innerHTML = tasks.filter(t => !t.date_completed).map(t => `
                <div class="task-card">
                    <span class="urgency-tag">PRIORITY ${t.urgency}</span>
                    <h3>${t.description}</h3>
                    <p>Status: <b>${t.assigned_to || 'Unassigned'}</b></p>
                    ${!t.assigned_to ? `<button onclick="assignTask(${t.row_number}, this)" class="btn-primary">Assign Best Worker</button>` : ''}
                    <button onclick="markComplete(${t.row_number})" class="btn-complete">Complete</button>
                </div>`).join('');

            // Worker Directory (Two lines + Assign button)
            document.getElementById('workersOverview').innerHTML = `<table class="worker-table">
                <tbody>${workers.map(w => {
                    const shifts = Object.entries(w.shifts).map(([d, s]) => `${d.split('-')[1]}/${d.split('-')[2]} ${s==1?'AM':'PM'}`).join(', ');
                    return `
                    <tr>
                        <td style="padding:15px;">
                            <div style="font-weight:bold;">${w.name} â€” <span style="font-weight:normal;">${w.job_title}</span></div>
                            <div style="font-size:0.8rem; color:#3b82f6; margin-top:4px;">DATES: ${shifts || 'None'}</div>
                        </td>
                        <td style="text-align:right">
                            <button onclick="assignWorker('${w.name}', this)" class="btn-self">Assign Task</button>
                            <button onclick="deleteItem('worker', '${w.name}')" class="btn-del">X</button>
                        </td>
                    </tr>`;
                }).join('')}</tbody></table>`;
        }

        document.getElementById('bulkAssignBtn').onclick = async () => {
            await fetch(`${API_URL}/assign-tasks-bulk`, {method:'POST'});
            loadData();
        };

        async function assignTask(id, btn) {
            btn.innerText = "...";
            const res = await fetch(`${API_URL}/assign-task-to-best`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({task_id:id})});
            const data = await res.json();
            if(!data.success) alert(data.message);
            loadData();
        }

        async function assignWorker(name, btn) {
            btn.innerText = "...";
            const res = await fetch(`${API_URL}/assign-worker-to-best`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({worker_name:name})});
            const data = await res.json();
            if(!data.success) alert(data.message);
            loadData();
        }

        // ... (rest of the standard form/calendar logic) ...
        loadData();
    </script>
</body>
</html>
